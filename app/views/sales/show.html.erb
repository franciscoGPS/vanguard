<%- model_class = Sale -%>
<div class="page-header">
  <h1>
    <%=t '.title', :default => model_class.model_name.human.titleize %>
    <%= "#{@greenhouse.business_name.capitalize}" %>
  </h1>
</div>

<%= render :partial => "greenhouses/submenu", :locals => {:id => @greenhouse.id } %>
<div class="well">
  <%= link_to t('.back', :default => t("helpers.links.back")),
              greenhouse_path(@sale.greenhouse_id) , :class => "btn btn-warning"  %>
  <%=link_to 'Generar Orden de Compra.', purshase_order_path(@greenhouse.id, @sale.id), class: "btn btn-primary" %>
  <%=link_to 'Factura de cruce', customs_billing_path(@greenhouse.id, @sale.id), class: "btn btn-success" %>
  <%@customers.each do |cust|%>
    <%= link_to "Facturar a "+ cust.business_name,
          new_greenhouse_sale_collections_bill_path(@greenhouse.id, @sale.id,
                                                                    :customer_id => cust.id), class: "btn btn-info" %>
  <% end %>
  <%= link_to t('.edit', :default => t("helpers.links.edit")),
              edit_greenhouse_sale_path(@sale.greenhouse_id, @sale.id), :class => 'btn btn-warning' %>
  <%= link_to t('.destroy', :default => t("helpers.links.destroy")),
              greenhouse_sale_path(@sale.greenhouse_id, @sale.id),
              :method => 'delete',
              :data => { :confirm => t('.confirm', :default => t("helpers.links.confirm", :default => 'Are you sure?')) },
              :class => 'btn btn-danger pull-right' %>
</div>
<div class="container">
  <div class="row">
    <div class="panel panel-default">
      <div class="panel-body">
        <div class="fieldset">
          <dl class="row">
              <div class="col-md-4 col-sm-12">
                <dt class="label label-default"><%= model_class.human_attribute_name(:shipment_number) %></dt>
                <dd><pre class="prettyprint"><%= "#{@sale.ship_number}" %></pre></dd>
              </div>
              <div class="col-md-4 col-sm-12">
                <dt class="label label-default"><%= model_class.human_attribute_name(:season) %></dt>
                <dd><pre class="prettyprint"><%= "#{@sale.season}" %></pre></dd>
              </div>
              <div class="col-md-4 col-sm-12">
                <dt class="label label-default"><%= model_class.human_attribute_name(:delivery_place) %></dt>
                <dd><pre class="prettyprint"><%= "#{@delivery_place.name}" %></pre></dd>
              </div>
              <div class="col-md-4 col-sm-12">
                <dt class="label label-default"><%= model_class.human_attribute_name(:departure_date) %></dt>
                <dd><pre class="prettyprint"><%= "#{@sale.departure_date}" %></pre></dd>
              </div>
              <div class="col-md-4 col-sm-12">
                <dt class="label label-default"><%= model_class.human_attribute_name(:arrival_date) %></dt>
                <dd><pre class="prettyprint"><%= "#{@sale.arrival_date}" %></pre></dd>
              </div>
              <div class="col-md-6 col-sm-12">
                <dt class="label label-default"><%= model_class.human_attribute_name(:observations) %></dt>
                <dd><pre class="prettyprint"><%= "#{@sale.annotation}" %></pre></dd>
              </div>
          </dl>

          <%= render :partial => 'confirmed_sales' %>
      </div>
    </div>
  </div>
</div>

 <div class="row">
   <div class="col-md-12">

        <%= hidden_field_tag(:sale_id_hidden, "#{@sale.id}")%>
        <h2 id="sale_id_status">Status</h2>
          <div class="col-md-3 col-sm-6">
              <%= label_tag "Orden de Compra", nil, class: "col-md-6" %>
              <%= check_box_tag :purshase_order_state_check, class: "col-md-6" %>
          </div>
            <div class="col-md-3 col-sm-6">
              <%= label_tag "Cuenta con Documentos", nil, class: "col-md-6" %>
              <%= check_box_tag :documents, class: "col-md-6" %>
            </div>
            <div class="col-md-3 col-sm-6">
              <%= label_tag "Salió de empaque", nil, class: "col-md-6" %>
              <%= check_box_tag :out_of_packaging, class: "col-md-6" %>
            </div>
            <div class="col-md-3 col-sm-6">
              <%= label_tag "Módulo aduana Mexicana", nil, class: "col-md-6" %>
              <%= check_box_tag :mex_customs_mod, class: "col-md-6" %>
              <div class="col-md-12">
              <%= label_tag "Rojo al pasar?", nil, class: "col-md-6" %>
              <%= check_box_tag :revision, class: "col-md-6" %>
            </div>
          </div>
            <div class="col-md-3 col-sm-6">
              <%= label_tag "Recepción de documentos", nil, class: "col-md-6" %>
              <%= check_box_tag :docs_reception, class: "col-md-6" %>
            </div>
            <div class="col-md-3 col-sm-6">
              <%= label_tag "Módulo aduana Americana", nil, class: "col-md-6" %>
              <%= check_box_tag :us_customs_mod, class: "col-md-6" %>
            </div>
            <div class="col-md-3 col-sm-6">
              <%= label_tag "USDA", nil, class: "col-md-6" %>
              <%= check_box_tag :usda, class: "col-md-6" %>
             </div>
            <div class="col-md-3 col-sm-6">
              <%= label_tag "FDA", nil, class: "col-md-6" %>
              <%= check_box_tag :fda, class: "col-md-6" %>
            </div>
            <div class="col-md-3 col-sm-6">
              <%= label_tag "Rampa", nil, class: "col-md-6" %>
              <%= check_box_tag :ramp, class: "col-md-6" %>
            </div>
          <div class="col-md-3 col-sm-6 form-group">
           <%= label_tag :cantidad, nil, class: "col-md-3 control-label" %>
             <div class=" col-md-8">
              <%= number_field_tag :hld_qty, class: "form-control" %>
            </div>
           <%= submit_tag "Save", id: "save_qty", class: "col-md-3 btn-xs" %>
          </div>
            <div class="col-md-3 col-sm-6">
              <%= label_tag "Documentacion de carga", nil, class: "col-md-6" %>
              <%= check_box_tag :loading_docs, class: "col-md-6" %>
            </div>
            <div class="col-md-3 col-sm-6">
              <%= label_tag "Llegó a bodega", nil, class: "col-md-6" %>
              <%= check_box_tag :arrived_to_warehouse, class: "col-md-6" %>
            </div>
            <div class="col-md-3 col-sm-6">
              <%= label_tag "Legó a frontera", nil, class: "col-md-6" %>
              <%= check_box_tag :arrived_to_border, class: "col-md-6" %>
            </div>
            <div class="col-md-3 col-sm-6">
              <%= label_tag "Recogió el cliente", nil, class: "col-md-6" %>
              <%= check_box_tag :picked_up_by_cust, class: "col-md-6" %>
            </div>
            <div class="col-md-3 col-sm-6">
              <%= label_tag "Salió del patio", nil, class: "col-md-6" %>
              <%= check_box_tag :out_of_courtyard, class: "col-md-6" %>
            </div>
            <div class="col-md-3 col-sm-6">
              <%= label_tag "BOL", nil, class: "col-md-6" %>
              <%= check_box_tag :bol, class: "col-md-6" %>
            </div>
      </div>
 </div>


  <div class="row">
     <%= render :partial => 'state_changes' %>
  </div>
 </div>

<script type="text/javascript">


  $(document)
    .ready(function (data) {

            $('#save_qty').prop('disabled', true);
            $('#hld_qty').prop('disabled', true);

          //Para precargar los valores que tiene el embarque, se hace una petición vacía
          enviar_ajax("", false);

        $('#save_qty').on("click", function(){
          var qty = $("#hld_qty").val();
          enviar_ajax("hld_qty", qty);

        });

      //###########   Los 12 eventos de los checkboxes y sus respectivas lógicas...
      //Ordenados de manera desendente
      //
      //=============================================================================

      //Evento accionado
      $('#purshase_order_state_check')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0)
            enviar_ajax(this.name, state);
        });

      //Segunda 2
      $('#out_of_packaging')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Tercera 3
      $('#docs_reception')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Cuarta 4
      $('#loading_docs')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Quinta 5
      $('#arrived_to_border')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Sexta 6
      $('#out_of_courtyard')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Séptima 7
      $('#documents')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Octava 8
      $('#mex_customs_mod')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Novena 9
      $('#us_customs_mod')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Décima 10
      $('#arrived_to_warehouse')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Undécima 11
      $('#picked_up_by_cust')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Duodécima 12
      $('#bol')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

        //revision 13
      $('#revision')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE

            enviar_ajax(this.name, state);
          }
        });

      //usda 14
      $('#usda')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //fda 15
      $('#fda')
        .on('switchChange.bootstrapSwitch', function (event, state) {
          if ($('#sale_id_hidden').val() > 0) {
            //Se verifica el estado del switch para saber si activar o desactivar
            //los campos de qty on hold
          if (state == false){
            $('#save_qty').prop('disabled', true);
            $('#hld_qty').prop('disabled', true);
            $('#save_qty').removeClass("btn-warning");
          }else{
            $('#save_qty').prop('disabled', false);
            $('#hld_qty').prop('disabled', false);
            $('#save_qty').addClass("btn-warning");
          }
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Rampa 16
      $('#ramp')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });




      //
      //=============================================================================

      function enviar_ajax(accion_param, checked) {

          var params = {
            accion: accion_param,
            //Cuando la función es llamada desde el botón para guardar la cantidad,
            //el valor de checked es un número y la acción es save_qty
            valor: checked,
            sale_id: $('#sale_id_hidden').val()
          };

            $.ajax({
            url: '<%= purshase_order_state_change_path %>',
            type: 'GET',
            data: $.param(params),
            dataType: 'json',
            success: function (dataRes) {

              //Recibir el objeto venta(Sale) y acomodar sus booleanos de los estados
              //updated_sale es el objeto tipo venta. Se convierte a objeto y se puede acceder a sus propiedades con el operador .  ej.a lert(updated_sale.aasm_state);
              //var updated_sale = $.parseJSON(dataRes);

              var updated_sale =  dataRes["sale"];
              seleccionar_campos(updated_sale);

              var action = dataRes["action"];
              var status = dataRes["status"];
              if(status){
                if(action == "hld_qty"){
                  disable_saving_fields();
                }
              }

            }
          });
      }

      function disable_saving_fields(){
                $('#save_qty').removeClass("btn-warning");
                $('#hld_qty').prop('disabled', true);
                $('#save_qty').prop('disabled', true);

      }

      function seleccionar_campos(sale) {
        /*
        Special Behaviours
          The method state can receive an optional third parameter skip. if true,
          switchChange event is not executed. The default is false.
          The method toggleState can receive an optional second parameter skip.
           if true, switchChange event is not executed. The default is false.
          The method wrapperClass can accepts a falsy value as second parameter.
           If so, it resets the class to its default.
         */
        $('#purshase_order_state_check').bootstrapSwitch('state', sale.purshase_order, true);
        //Segunda 2
        $('#out_of_packaging').bootstrapSwitch('state', sale.out_of_packaging, true);
        //Tercera 3
        $('#docs_reception').bootstrapSwitch('state', sale.docs_reception, true);
        //Cuarta 4
        $('#loading_docs').bootstrapSwitch('state', sale.loading_docs, true);
        //Quinta 5
        $('#arrived_to_border').bootstrapSwitch('state', sale.arrived_to_border, true);
        //Sexta 6
        $('#out_of_courtyard').bootstrapSwitch('state', sale.out_of_courtyard, true);
        //Séptima 7
        $('#documents').bootstrapSwitch('state', sale.documents, true);
        //Octava 8
        $('#mex_customs_mod').bootstrapSwitch('state', sale.mex_customs_mod, true);
        //Novena 9
        $('#us_customs_mod').bootstrapSwitch('state', sale.us_customs_mod, true);
        //Décima 10
        $('#arrived_to_warehouse').bootstrapSwitch('state', sale.arrived_to_warehouse, true);
        //Undécima 11
        $('#picked_up_by_cust').bootstrapSwitch('state', sale.picked_up_by_cust, true);
        //Duodécima 12
        $('#bol').bootstrapSwitch('state', sale.bol, true);
        //Revisión 13
        $('#revision').bootstrapSwitch('state', sale.revision, true);
        // usda 14
        $('#usda').bootstrapSwitch('state', sale.usda, true);
        //fda 15
        $('#fda').bootstrapSwitch('state', sale.fda, true);
        //rampa 16
        $('#ramp').bootstrapSwitch('state', sale.ramp, true);

        //cantidad retenida en FDA 18
        $('#hld_qty').val(sale.hld_qty);

      }

      //Fin del ready y 1er function
    });
</script>
