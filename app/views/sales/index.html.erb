<%- model_class = Sale -%>
<div class="page-header">
<h1><%=t '.title', :default => model_class.model_name.human.pluralize.titleize %></h1>
</div>
<%= link_to t('.new', :default => t("helpers.links.new")),
new_sale_path,
:class => 'btn btn-primary' %>
<table class="table table-striped">
<thead>
<tr>
<th><%= model_class.human_attribute_name(:id) %></th>
<th><%= model_class.human_attribute_name(:customer) %></th>
<th><%= model_class.human_attribute_name(:season) %></th>
<th><%= model_class.human_attribute_name(:departure_date) %></th>
<th><%= model_class.human_attribute_name(:arrival_date) %></th>
<th><%= model_class.human_attribute_name(:created_at) %></th>
<th><%= model_class.human_attribute_name(:state) %></th>
<th><%= model_class.human_attribute_name(:next_event) %></th>
<th><%=t '.actions', :default => t("helpers.actions") %></th>
</tr>
</thead>
<tbody>
<% @sales.each do |sale| %>
  <tr>
  <td><%= sale.id %></td>
  <td><%= sale.customer.business_name %></td>
  <td><%= sale.season %></td>
  <td><%= sale.departure_date.to_formatted_s(:long) %></td>
  <td><%= sale.arrival_date.to_formatted_s(:long)%></td>
  <td><%=l sale.created_at, format: :long %></td>
    <td class="col-md-3">
      <%= $states_to_s[sale.aasm_state.to_sym][:name] %>
    <div class="progress">
    <div class="progress-bar progress-bar-success progress-bar-striped" role="progressbar" style="width:<%= sale.completed_states_size %>%">
        <%= ($states_to_s[sale.aasm_state.to_sym][:id].to_f - 1).round %> Stages Completed
    </div>
      <!-- En esta siguiente línea se calcula el ancho del área verde. -->
    <div class="progress-bar progress-bar-warning progress-bar-striped" role="progressbar" style="width:<%= sale.actual_state_size%>%">
       <%= ($states_to_s[sale.aasm_state.to_sym][:id].to_f).round %>º
    </div>
    <div class="progress-bar progress-bar-danger progress-bar-striped" role="progressbar" style="width:<%= sale.pending_states_size%>%">
    <%= 8 - $states_to_s[sale.aasm_state.to_sym][:id].to_f.round %> Pending stages
    </div>
    </div>
    </td>
    <td><% if sale.aasm_state.to_s == "carrier_courtyard_checkin" %>
    <%= button_to "To modules line", { action: "to_modules_line", sale_id: sale.id }, form_class: "boton_rojo" %>

    <% elsif sale.aasm_state.to_s == "courtyard_to_modules_line" %>
    <%= button_to "To Mexican modules", { action: "to_mexican_modules", sale_id: sale.id } %>


    <% elsif sale.aasm_state.to_s == "mexican_modules" %>

    <%= form_tag("to_american_modules", method: "post") do %>
      <%= label_tag(:revision, "Rojo") %>
      <%= check_box_tag(:sale, :revision) %>
      <br/>
      <%= hidden_field_tag(:sale_id, sale.id) %>
      <%= submit_tag("To American modules") %>
    <% end %>
      <% elsif sale.aasm_state.to_s == "american_modules" %>
      <%= button_to "To FDA Inspection", { action: "to_fda_inspection", sale_id: sale.id  }%>

      <% elsif sale.aasm_state.to_s == "fda_inspection" %>

      <%= form_tag("to_warehouse", method: "post") do %>
        <%= label_tag(:comment, "Observations") %>
        <%= text_field(:sale, :comment) %>
        <%= hidden_field_tag(:sale_id, sale.id) %>
        <%= submit_tag("To warehouse") %>
      <% end %>

        <% elsif sale.aasm_state.to_s == "to_warehouse" %>
        <%= button_to "Delivered", { action: "delivered",  sale_id: sale.id }, {} %>

        <% elsif sale.aasm_state.to_s == "delivered" %>
        <%= button_to "Pay", { action: "payed", sale_id: sale.id }%>

        <% elsif sale.aasm_state.to_s == "payed" %>
        <%= link_to sale_path(sale), :class => 'btn btn-xs', :title => "#{ t('.show', :default => t('helpers.links.show')) }" do %>
          <i class="fa fa-info fw"></i>
          <%- end -%>


          <% end %>

          </td>


          <td>
          <%= link_to sale_path(sale), :class => 'btn btn-xs', :title => "#{ t('.show', :default => t('helpers.links.show')) }" do %>
            <i class="fa fa-info fw"></i>
            <%- end -%>
            <%= link_to edit_sale_path(sale), :class => 'btn btn-xs', :title => "#{ t('.edit', :default => t('helpers.links.edit')) }" do %>
              <i class="fa fa-pencil fw"></i>
              <%- end -%>
              <%= link_to sale_path(sale), :method => :delete, :data => { :confirm => t('.confirm', :default => t("helpers.links.confirm", :default => 'Are you sure?')) }, :class => 'btn btn-xs', :title => "#{ t('.destroy', :default => t('helpers.links.destroy')) }" do %>
                <i class="fa fa-trash-o fw"></i>
                <%- end -%>
                </td>
                </tr>
                <% end %>
                </tbody>
                </table>



