<% environment.context_class.instance_eval { include Rails.application.routes.url_helpers } %>


//Page specific code. Read more on:
//http://railsapps.github.io/rails-javascript-include-external.html

      $('body.sales.show').ready(function(){
          if ($('body.sales.show').length) {
            initialize_values();
          }
      });

      $('body.greenhouses.show').ready(function(){
          if ($('body.greenhouses.show').length) {
            initialize_values();
          }
      });


      function initialize_values(){
            disable_saving_fields();
            enviar_ajax("", false);
      }
// End of "Page specific code".

      /*$(document).ready(function () {
        alert("document).ready(function ()");
       });


  document.addEventListener("turbolinks:load", function (data) {
    alert("sales_state_machine ready");



            //$('#save_qty').prop('disabled', true);
            //$('#hld_qty').prop('disabled', true);

            /*$("tr[data-link]").click(function() {
                window.location = $(this).data("link")
            }).children('input[name=selected]:radio').click(function(e) {
                return false;
            });

          //Para precargar los valores que tiene el embarque, se hace una petición vacía

        });*/

          $('input[name=selected]:radio')
              .on('change', function () {

          //Establece el valor en el campo oculto dependiendo de la venta que que se vaya a actualizar
          $('#sale_id_hidden').val($(this).val());
          //Establece el valor de la venta en la parte d elos controles.
          //Se puede poblar cualquier campo a partir de este id
          $('#sale_id_status').html("Shipment - " + $(this).val());

          enviar_ajax("", false);

        });

        $('#save_qty').on("click", function(){
          var qty = $("#hld_qty").val();
          enviar_ajax("hld_qty", qty);

        });



      //###########   Los 12 eventos de los checkboxes y sus respectivas lógicas...
      //Ordenados de manera desendente
      //
      //=============================================================================

      //Evento accionado
      $('#purshase_order_state_check')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0)
            enviar_ajax(this.name, state);
        });

      //Segunda 2
      $('#out_of_packaging')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Tercera 3
      $('#docs_reception')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Cuarta 4
      $('#loading_docs')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Quinta 5
      $('#arrived_to_border')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Sexta 6
      $('#out_of_courtyard')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Séptima 7
      $('#documents')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Octava 8
      $('#mex_customs_mod')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Novena 9
      $('#us_customs_mod')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Décima 10
      $('#arrived_to_warehouse')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Undécima 11
      $('#picked_up_by_cust')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Duodécima 12
      $('#bol')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

        //revision 13
      $('#revision')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE

            enviar_ajax(this.name, state);
          }
        });

      //usda 14
      $('#usda')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //fda 15
      $('#fda')
        .on('switchChange.bootstrapSwitch', function (event, state) {
          if ($('#sale_id_hidden').val() > 0) {
            //Se verifica el estado del switch para saber si activar o desactivar
            //los campos de qty on hold
          if (state == false){
            $('#save_qty').prop('disabled', true);
            $('#hld_qty').prop('disabled', true);
            $('#save_qty').removeClass("btn-warning");
          }else{
            $('#save_qty').prop('disabled', false);
            $('#hld_qty').prop('disabled', false);
            $('#save_qty').addClass("btn-warning");
          }
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });

      //Rampa 16
      $('#ramp')
        .on('switchChange.bootstrapSwitch', function (event, state) {

          if ($('#sale_id_hidden').val() > 0) {
            //Se envían los valores para los parámetros del ajax
            //Los valores son:
            //-El nombre del campo (Que es el correspondiente al estado solicitado o clickado)
            //-El valor de si fue clickado hacia TRUE o FALSE
            enviar_ajax(this.name, state);
          }
        });




      //
      //=============================================================================

      function enviar_ajax(accion_param, checked) {

          var params = {
            event: accion_param,
            //Cuando la función es llamada desde el botón para guardar la cantidad,
            //el valor de checked es un número y la acción es save_qty
            value: checked,
            sale_id: $('#sale_id_hidden').val()
          };


            $.ajax({
            url: '<%= purshase_order_state_change_path %>',
            type: 'GET',

            data: $.param(params),
            dataType: 'json',
            success: function (dataRes) {

              //Recibir el objeto venta(Sale) y acomodar sus booleanos de los estados
              //updated_sale es el objeto tipo venta. Se convierte a objeto y se puede acceder a sus propiedades con el operador .  ej.a lert(updated_sale.aasm_state);
              //var updated_sale = $.parseJSON(dataRes);

              var updated_sale =  dataRes["sale"];

              console.log(updated_sale);


              if(updated_sale == null){
                show_error("server_error");
              }
              else{
                seleccionar_campos(updated_sale);
                var event = dataRes["event"];
                var status = dataRes["status"];
                if(status){
                  if(event == "hld_qty"){
                    disable_saving_fields();
                  }
                }
              }
            }
          });
      }

      function disable_saving_fields(){
                $('#save_qty').removeClass("btn-warning");
                $('#hld_qty').prop('disabled', true);
                $('#save_qty').prop('disabled', true);

      }

      function seleccionar_campos(sale) {
        /*
        Special Behaviours
          The method state can receive an optional third parameter skip. if true,
          switchChange event is not executed. The default is false.
          The method toggleState can receive an optional second parameter skip.
           if true, switchChange event is not executed. The default is false.
          The method wrapperClass can accepts a falsy value as second parameter.
           If so, it resets the class to its default.
         */
        $('#purshase_order_state_check').bootstrapSwitch('state', sale.purshase_order, true);
        //Segunda 2
        $('#out_of_packaging').bootstrapSwitch('state', sale.out_of_packaging, true);
        //Tercera 3
        $('#docs_reception').bootstrapSwitch('state', sale.docs_reception, true);
        //Cuarta 4
        $('#loading_docs').bootstrapSwitch('state', sale.loading_docs, true);
        //Quinta 5
        $('#arrived_to_border').bootstrapSwitch('state', sale.arrived_to_border, true);
        //Sexta 6
        $('#out_of_courtyard').bootstrapSwitch('state', sale.out_of_courtyard, true);
        //Séptima 7
        $('#documents').bootstrapSwitch('state', sale.documents, true);
        //Octava 8
        $('#mex_customs_mod').bootstrapSwitch('state', sale.mex_customs_mod, true);
        //Novena 9
        $('#us_customs_mod').bootstrapSwitch('state', sale.us_customs_mod, true);
        //Décima 10
        $('#arrived_to_warehouse').bootstrapSwitch('state', sale.arrived_to_warehouse, true);
        //Undécima 11
        $('#picked_up_by_cust').bootstrapSwitch('state', sale.picked_up_by_cust, true);
        //Duodécima 12
        $('#bol').bootstrapSwitch('state', sale.bol, true);
        //Revisión 13
        $('#revision').bootstrapSwitch('state', sale.revision, true);
        // usda 14
        $('#usda').bootstrapSwitch('state', sale.usda, true);
        //fda 15
        $('#fda').bootstrapSwitch('state', sale.fda, true);
        //rampa 16
        $('#ramp').bootstrapSwitch('state', sale.ramp, true);

        //cantidad retenida en FDA 18
        $('#hld_qty').val(sale.hld_qty);

      }

      //Fin del ready y 1er function

